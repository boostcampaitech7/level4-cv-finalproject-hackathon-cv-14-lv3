{
  "name": "trend_send_mail",
  "nodes": [
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "trend_product",
        "limit": 100
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        700,
        -160
      ],
      "id": "80dad646-0e54-4716-ad59-86072f61c952",
      "name": "Supabase",
      "credentials": {
        "supabaseApi": {
          "id": "Pt6nV2B9ZR7Nq7KD",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "results",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        860,
        -160
      ],
      "id": "295e2c94-ca1f-4908-8272-46921f9880cd",
      "name": "Aggregate"
    },
    {
      "parameters": {
        "jsCode": "// ì…ë ¥ ë°ì´í„°ì—ì„œ results ë°°ì—´ ê°€ì ¸ì˜¤ê¸°\nconst items = $input.first().json.results;\n\n// ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì•„ì´í…œì„ ê·¸ë£¹í™”í•˜ê³  ë­í¬ë³„ë¡œ ì •ë ¬\nconst processedItems = items.reduce((acc, item) => {\n  const {\n    category,\n    rank,\n    product_name,\n    start_date,\n    end_date\n  } = item;\n\n  // ì¹´í…Œê³ ë¦¬ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”\n  if (!acc[category]) {\n    acc[category] = {\n      category: category,\n      period: `${start_date} ~ ${end_date}`,\n      trends: []\n    };\n  }\n\n  // ë­í¬ 5ìœ„ê¹Œì§€ë§Œ ìˆ˜ì§‘\n  if (rank <= 5) {\n    acc[category].trends.push({\n      rank: rank,\n      product_name: product_name\n    });\n  }\n\n  return acc;\n}, {});\n\n// ê°ì²´ë¥¼ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  trendsë¥¼ ë­í¬ ìˆœìœ¼ë¡œ ì •ë ¬\nconst sortedResults = Object.values(processedItems).map(categoryData => {\n  return {\n    ...categoryData,\n    trends: categoryData.trends.sort((a, b) => a.rank - b.rank)\n  };\n});\n\n// results í‚¤ë¡œ ê°ì‹¸ì„œ ë°˜í™˜\nreturn {\n  results: sortedResults\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1020,
        -160
      ],
      "id": "a9c8d1f7-2109-4d5d-81fb-fc958e5e0cd2",
      "name": "Info_Extractor"
    },
    {
      "parameters": {
        "jsCode": "// ì…ë ¥ ë°ì´í„°ì—ì„œ results ë°°ì—´ ê°€ì ¸ì˜¤ê¸°\nconst items = $input.first().json.results;\n\n// ì´ë©”ì¼ ë‚´ìš© ìƒì„± í•¨ìˆ˜\nfunction generateEmailContent(data) {\n // í˜„ì¬ ë‚ ì§œ í¬ë§·íŒ…\n const today = new Date();\n const formattedDate = today.toLocaleDateString('ko-KR', {\n   year: 'numeric',\n   month: 'long',\n   day: 'numeric'\n });\n\n // ì´ë©”ì¼ í—¤ë”\n let emailContent = `\nì›”ê°„ ìƒí’ˆ íŠ¸ë Œë“œ ë¶„ì„ ë¦¬í¬íŠ¸\nì‘ì„±ì¼: ${formattedDate}\nâ€» ë³¸ ê²°ê³¼ëŠ” ë„¤ì´ë²„ ë°ì´í„°ë©(Naver Datalab)ì˜ ì‡¼í•‘ íŠ¸ë Œë“œ ë°ì´í„°ë¥¼ ì°¸ì¡°í•˜ì˜€ìŠµë‹ˆë‹¤.\n`;\n\n // ê° ì¹´í…Œê³ ë¦¬ë³„ íŠ¸ë Œë“œ ì •ë³´ ì¶”ê°€\n data.forEach(category => {\n   emailContent += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“ˆ ${category.category} íŠ¸ë Œë“œ\nê¸°ê°„: ${category.period}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;\n\n   // íŠ¸ë Œë“œ ìƒí’ˆ ëª©ë¡ ì¶”ê°€\n   category.trends.forEach(trend => {\n     emailContent += `${trend.rank}. ${trend.product_name}\\n`;\n   });\n\n   // ì¹´í…Œê³ ë¦¬ë³„ ë¶„ì„ ìš”ì•½ ì¶”ê°€\n   const topProduct = category.trends[0];\n   emailContent += `\n- ì´ë²ˆ ê¸°ê°„ ${category.category} ì¹´í…Œê³ ë¦¬ì˜ ìµœìƒìœ„ íŠ¸ë Œë“œ ìƒí’ˆì€ \"${topProduct.product_name}\"ì…ë‹ˆë‹¤.\n`;\n });\n\n // ì´ë©”ì¼ í‘¸í„°\n emailContent += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâ€» ë³¸ ë¦¬í¬íŠ¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ëœ íŠ¸ë Œë“œ ë¶„ì„ ë°ì´í„°ì…ë‹ˆë‹¤.\nâ€» ë°ì´í„° ì¶œì²˜: ë„¤ì´ë²„ ë°ì´í„°ë© ì‡¼í•‘ì¸ì‚¬ì´íŠ¸\n`;\n\n return emailContent;\n}\n\n// ì´ë©”ì¼ ì œëª© ìƒì„±\nconst emailSubject = `[íŠ¸ë Œë“œ ë¦¬í¬íŠ¸] ${items[0].period} ì¹´í…Œê³ ë¦¬ë³„ ìƒí’ˆ íŠ¸ë Œë“œ ë¶„ì„`;\n\n// ì´ë©”ì¼ ë³¸ë¬¸ ìƒì„±\nconst emailBody = generateEmailContent(items);\n\n// ê²°ê³¼ ë°˜í™˜\nreturn {\n email_data: {\n   subject: emailSubject,\n   body: emailBody\n }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1180,
        -160
      ],
      "id": "8aa6af37-74ed-4960-862b-42d6525f6cc7",
      "name": "Abstract_Info"
    },
    {
      "parameters": {
        "sendTo": "taehan5479@gmail.com",
        "subject": "={{ $json.email_data.subject }}",
        "emailType": "text",
        "message": "={{ $json.email_data.body }}",
        "options": {
          "senderName": "GORANI"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1340,
        -160
      ],
      "id": "04a7a220-1910-45a9-b11c-b10e9e02b196",
      "name": "Send_Trend_Info",
      "webhookId": "39c1f4f0-bd62-4959-a948-06a551cdbfeb",
      "credentials": {
        "gmailOAuth2": {
          "id": "ged36ZWz56iSUfsj",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "trending",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        520,
        -160
      ],
      "id": "b61a09c9-205c-4a1a-a734-109f936cb152",
      "name": "Webhook",
      "webhookId": "cdb69a71-57fd-4ccb-ac47-878e9b855b60"
    },
    {
      "parameters": {
        "content": "### íŠ¸ë Œë“œ ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸°\nDBì˜ trend_product í…Œì´ë¸” ê°’ ë¶ˆëŸ¬ì˜¤ê¸°",
        "height": 240,
        "width": 300,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        680,
        -240
      ],
      "typeVersion": 1,
      "id": "acf14e2e-f4fb-4dd8-a36b-628e2501fa84",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "### ë©”ì¼ ì•Œë¦¼ ë°œì†¡\nê´€ë¦¬ì ì´ë©”ì¼ë¡œ íŠ¸ë Œë“œ ìƒí’ˆ ë³´ê³ ì„œ ë°œì†¡",
        "height": 240,
        "width": 460
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1000,
        -240
      ],
      "typeVersion": 1,
      "id": "e3f4ce9c-d7ad-42a1-a6c8-81e5aa24ef5e",
      "name": "Sticky Note1"
    }
  ],
  "pinData": {},
  "connections": {
    "Supabase": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "Info_Extractor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Info_Extractor": {
      "main": [
        [
          {
            "node": "Abstract_Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Abstract_Info": {
      "main": [
        [
          {
            "node": "Send_Trend_Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "31dbd5ac-1d85-4640-86f4-c5d0a1c5283a",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "89ddddfba8d870bb904e2070b342d6e3bd595dc49e89131cde59469edd32e972"
  },
  "id": "PNhZwCY2KvprvWob",
  "tags": []
}